<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Profile ‚Äî skillShare</title>

  <!-- main stylesheet -->
  <link rel="stylesheet" href="styles.css">

  <!-- Instagram-style additions -->
  <style>
  /* profile header */
  .profile-card{display:flex;gap:32px;align-items:center;flex-wrap:wrap}
  .profile-avatar .user-avatar.large{width:116px;height:116px;font-size:46px}
  .profile-info h2{font:600 20px/1.3 'Inter',sans-serif;margin:.15em 0}
  .profile-stats{display:flex;gap:24px;margin-top:8px}
  .stat-number{font:600 18px}

  /* tab bar */
  .profile-nav{margin:34px 0 14px;display:flex;gap:12px}
  .tab-btn{flex:1;padding:9px 0;border:none;cursor:pointer;background:#f4f4f4;border-radius:6px;font:600 14px/1 'Inter',sans-serif}
  .tab-btn.active,.tab-btn:hover{background:#e1e1e1}

  /* posts grid */
  .posts-grid{display:grid;gap:6px;grid-template-columns:repeat(auto-fill,minmax(122px,1fr))}
  .post-thumb{position:relative;overflow:hidden;aspect-ratio:1/1}
  .post-thumb img,.post-thumb video{width:100%;height:100%;object-fit:cover;transition:transform .25s}
  .post-thumb:hover img,.post-thumb:hover video{transform:scale(1.05)}
  .post-thumb .owner{position:absolute;bottom:4px;left:4px;background:rgba(0,0,0,.6);color:#fff;font-size:11px;padding:2px 4px;border-radius:3px}

  /* helper */
  .hidden{display:none}
  </style>
</head>

<body class="dashboard-body">
  <div class="dashboard-container">

    <!-- Navigation -->
    <nav class="dashboard-nav">
      <div class="nav-brand"><h3>üîí SecretShare</h3></div>

      <div class="nav-links">
        <a href="home.html"      class="nav-link"><span class="nav-icon">üè†</span>Feed</a>
        <a href="profile.html"   class="nav-link active"><span class="nav-icon">üë§</span>Profile</a>
        <a href="createone.html" class="nav-link"><span class="nav-icon">‚ûï</span>Share Secret</a>
      </div>

      <button class="btn secondary logout-btn" id="logout">Sign out</button>
    </nav>

    <!-- Main -->
    <main class="dashboard-main">
      <div class="profile-container">

        <!-- header -->
        <header class="page-header">
          <h1>Your profile</h1>
          <p class="page-subtitle">Manage your account &amp; see your posts</p>
        </header>

        <!-- overview -->
        <section class="profile-overview">
          <div class="profile-card">
            <div class="profile-avatar">
              <div class="user-avatar large" id="profile-avatar">üë§</div>
              <button class="btn secondary small">Change avatar</button>
            </div>

            <div class="profile-info">
              <h2 id="profile-display-name">Loading‚Ä¶</h2>
              <p  id="profile-display-email">Loading‚Ä¶</p>

              <div class="profile-stats">
                <div class="stat"><span class="stat-number" id="videos-count">0</span><span class="stat-label">Videos</span></div>
                <div class="stat"><span class="stat-number" id="followers-count">0</span><span class="stat-label">Followers</span></div>
                <div class="stat"><span class="stat-number" id="following-count">0</span><span class="stat-label">Following</span></div>
                <div class="stat"><span class="stat-number" id="total-views">0</span><span class="stat-label">Views</span></div>
              </div>
            </div>
          </div>
        </section>

        <!-- tabs -->
        <nav class="profile-nav">
          <button class="tab-btn active" data-tab="posts">POSTS</button>
          <button class="tab-btn"        data-tab="edit">EDIT PROFILE</button>
        </nav>

        <!-- posts -->
        <section id="posts" class="tab-panel">
          <div id="posts-grid" class="posts-grid"><!-- thumbnails injected here --></div>
        </section>

        <!-- edit profile -->
        <section id="edit" class="tab-panel hidden">
          <div class="settings-container">
            <!-- (all forms exactly as you already had) -->
            ‚Ä¶ your existing settings HTML ‚Ä¶
          </div>
        </section>

        <div id="profile-message" class="message"></div>
      </div>
    </main>
  </div>

  <!-- scripts -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.min.js"></script>
  <script src="config.js"></script>     <!-- sets const sb = supabase.createClient(...) -->
  <script src="dashboard.js"></script>  <!-- sets currentUser, etc. -->

  <!-- local logic -->
  <script>
  /* tab switching */
  document.querySelectorAll('.tab-btn').forEach(btn=>{
    btn.onclick = () => {
      document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      const tab = btn.dataset.tab;                 // "posts" | "edit"
      document.querySelectorAll('.tab-panel')
              .forEach(p=>p.classList.toggle('hidden', p.id!==tab));
      if(tab==='posts' && currentUser) loadMyPosts(currentUser.id);
    };
  });

  /* fetch current user then load grid */
  let currentUser;
  sb.auth.getUser().then(({ data, error })=>{
    if(error){console.error(error);return;}
    currentUser = data.user;
    if(currentUser) loadMyPosts(currentUser.id);
  });

  /* load videos + owner info */
  async function loadMyPosts(uid){
    const grid = document.getElementById('posts-grid');
    if(!grid) return;

    const { data: vids, error } = await sb
      // OPTION 1 ‚Äì if you created the view
      .from('videos_with_user')
      .select('id, title, video_url, thumbnail_url, username, avatar_url')
      .eq('user_id', uid)
      .order('created_at',{ascending:false});

      /*  OPTION 2 ‚Äì if you DID NOT create the view:
      .from('videos')
      .select(`
        id, title, video_url, thumbnail_url,
        profiles:user_id (username, avatar_url)
      `)
      .eq('user_id', uid)
      .order('created_at',{ascending:false});
      */

    if(error){console.error(error);return;}

    grid.innerHTML = vids.map(v=>{
      const thumb = v.thumbnail_url ?? `${v.video_url}#t=2`;
      const user  = v.username || (v.profiles && v.profiles.username) || 'user';
      return `
        <a class="post-thumb" href="watch.html?id=${v.id}" title="${v.title}">
          <img src="${thumb}" alt="${v.title}">
          <span class="owner">@${user}</span>
        </a>`;
    }).join('');
  }
  </script>
</body>
</html>
